name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # Change to master if that's your default branch name

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v1
        
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: '14'
      
      - name: Create .nojekyll file
        run: touch .nojekyll
      
      - name: Install Basic Dependencies
        run: npm install -g fs path
      
      - name: Create Path Fixing Script
        run: |
          cat > fix-paths.js << 'EOL'
          const fs = require('fs');
          const path = require('path');
          
          // Log output function to help debug
          function log(message) {
            console.log(`[PathFixer] ${message}`);
          }
          
          // Find all HTML files
          function findHtmlFiles(dir) {
            let results = [];
            const files = fs.readdirSync(dir);
            
            for (const file of files) {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory() && 
                  file !== 'node_modules' && 
                  file !== '.git' && 
                  file !== '.github') {
                results = results.concat(findHtmlFiles(filePath));
              } else if (file.endsWith('.html')) {
                results.push(filePath);
              }
            }
            
            return results;
          }
          
          // Fix HTML files
          const htmlFiles = findHtmlFiles('.');
          log(`Found ${htmlFiles.length} HTML files to process`);
          
          htmlFiles.forEach(filePath => {
            log(`Processing ${filePath}`);
            
            let content = fs.readFileSync(filePath, 'utf8');
            
            // Check if this is a game file
            const isGameFile = filePath.includes('/games/') && 
                               !filePath.includes('/game-template') &&
                               !filePath.includes('check-paths.html');
            
            // Add base tag
            if (!content.includes('<base href=')) {
              if (isGameFile) {
                log(`Adding game base tag to ${filePath}`);
                content = content.replace(
                  '<head>', 
                  '<head>\n  <base href="../../">'
                );
              } else {
                log(`Adding base tag to ${filePath}`);
                content = content.replace(
                  '<head>', 
                  '<head>\n  <base href="./">'
                );
              }
            }
            
            // Fix path references
            content = content.replace(
              /href=["']\/(?!\/|http|https)([^"']*)["']/g, 
              'href="./$1"'
            );
            
            content = content.replace(
              /src=["']\/(?!\/|http|https)([^"']*)["']/g, 
              'src="./$1"'
            );
            
            fs.writeFileSync(filePath, content, 'utf8');
          });
          
          log('HTML files processed successfully');
          EOL
          
          node fix-paths.js
      
      - name: Setup Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      
      - name: Deploy to gh-pages branch
        run: |
          # Create a new branch without history
          git checkout --orphan gh-pages
          
          # Add all files
          git add .
          git add .nojekyll
          
          # Commit files
          git commit -m "Deploy to GitHub Pages"
          
          # Force push to gh-pages branch
          git push -f origin gh-pages
